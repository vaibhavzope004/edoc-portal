<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CSC Application Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
        

    <link rel="stylesheet" th:href="@{/css/pages/csc-application-detail.css}" href="/css/pages/csc-application-detail.css">
</head>
<body>

<div th:replace="~{fragments/layout :: header}"></div>

<div class="wrap">
    <div class="title-row">
        <h2>CSC Application Management</h2>
        <a class="btn btn-soft" th:href="@{/csc/manage-applications}">Back</a>
    </div>

    <div th:if="${success}" class="msg ok" th:text="${success}"></div>
    <div th:if="${error}" class="msg err" th:text="${error}"></div>

    <div class="grid">
        <div class="card">
            <h3>Customer Information</h3>
            <div class="details-grid">
                <p><b>Customer Name:</b> <span th:text="${customer != null and customer.fullName != null and !#strings.isEmpty(customer.fullName) ? customer.fullName : (app.customerName != null and !#strings.isEmpty(app.customerName) ? app.customerName : app.name)}"></span></p>
                <p><b>Customer Email:</b> <span th:text="${customer != null and customer.email != null and !#strings.isEmpty(customer.email) ? customer.email : app.customerEmail}"></span></p>
                <p><b>Customer Mobile:</b> <span th:text="${customer != null and customer.mobileNumber != null and !#strings.isEmpty(customer.mobileNumber) ? customer.mobileNumber : '-'}"></span></p>
                <p><b>Customer ID:</b> <span th:text="${customer != null and customer.id != null ? customer.id : '-'}"></span></p>
            </div>
        </div>

        <div class="card">
            <h3>Application Form Details</h3>
            <div class="details-grid" style="margin-bottom:12px;">
                <p><b>Applicant Name:</b> <span th:text="${app.applicantName != null and !#strings.isEmpty(app.applicantName) ? app.applicantName : '-'}"></span></p>
                <p><b>Mobile:</b> <span th:text="${app.mobile}"></span></p>
                <p><b>Service Type:</b> <span th:text="${app.serviceType}"></span></p>
                <p class="full"><b>Description:</b> <span th:text="${app.description != null and !#strings.isEmpty(app.description) ? app.description : '-'}"></span></p>
            </div>
            <table>
                <thead>
                <tr>
                    <th>Document Type</th>
                    <th>File Name</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${#lists.isEmpty(app.uploadedDocuments)}">
                    <td colspan="3">No documents uploaded by customer.</td>
                </tr>
                <tr th:each="doc : ${app.uploadedDocuments}">
                    <td th:text="${doc.documentType != null ? doc.documentType : 'Document'}"></td>
                    <td th:text="${doc.fileName}"></td>
                    <td>
                        <a class="btn btn-view btn-sm"
                           th:href="@{/csc/application/{id}(id=${app.id},previewDocId=${doc.id},status=${selectedStatus})}">View</a>
                        <a class="btn btn-success btn-sm" th:href="@{'/csc/application/document/' + ${doc.id} + '/download'}">Download</a>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="preview-overlay" th:if="${previewDocId != null}">
                <div class="preview-window">
                    <div class="preview-tabs">
                        <span class="preview-tab active">Document Preview</span>
                        <div class="preview-actions">
                            <a class="preview-icon-btn"
                               th:href="@{'/csc/application/document/' + ${previewDocId} + '/view'}"
                               target="_blank"
                               rel="noopener"
                               title="Open in new window"
                               aria-label="Open in new window">
                                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <path d="M14 3h7v7"></path>
                                    <path d="M10 14 21 3"></path>
                                    <path d="M21 14v6a1 1 0 0 1-1 1h-16a1 1 0 0 1-1-1v-16a1 1 0 0 1 1-1h6"></path>
                                </svg>
                            </a>
                            <a class="preview-icon-btn"
                               th:href="@{/csc/application/{id}(id=${app.id},status=${selectedStatus})}"
                               title="Close preview"
                               aria-label="Close preview">
                                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <path d="M18 6 6 18"></path>
                                    <path d="M6 6 18 18"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                    <div class="preview-body">
                        <iframe class="preview-frame" title="Document preview" loading="lazy" th:src="@{'/csc/application/document/' + ${previewDocId} + '/view'}"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Application Status Update</h3>
            <p class="muted">Select status from dropdown, load mapped fields, then submit update.</p>
            <form class="status-toolbar" th:action="@{/csc/application/{id}(id=${app.id})}" method="get">
                <input type="hidden" name="previewDocId" th:if="${previewDocId != null}" th:value="${previewDocId}">
                <label for="statusViewSelect">Application Status</label>
                <select class="field" id="statusViewSelect" name="status" onchange="this.form.submit()" required>
                    <option th:each="s : ${statuses}"
                            th:value="${s.name()}"
                            th:text="${s.name()}"
                            th:selected="${selectedStatus == s.name()}"></option>
                </select>
                <noscript>
                    <button class="btn btn-soft" type="submit">Load Status</button>
                </noscript>
            </form>

            <form th:action="@{/csc/application/update-status}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="id" th:value="${app.id}">
                <input type="hidden" name="status" th:value="${selectedStatus}">
                <p class="muted"><b>Current mode:</b> <span th:text="${selectedStatus}">PENDING</span></p>

                <div id="successFields" th:if="${selectedStatus == 'SUCCESS'}">
                    <label for="issuedDocument">Upload Issued Document</label>
                    <input id="issuedDocument" class="field" type="file" name="issuedDocument" accept=".pdf,application/pdf">
                    <p class="muted" th:if="${app.successLikeStatus and app.issuedDocumentAvailable}">Existing issued document is available. Upload only if replacing.</p>
                    <label for="successMessage">Description (Optional)</label>
                    <textarea id="successMessage" class="textarea" name="message" placeholder="Optional description for customer"></textarea>
                </div>

                <div id="rejectedFields" th:if="${selectedStatus == 'REJECTED'}">
                    <label for="rejectionMessage">Description</label>
                    <textarea id="rejectionMessage" class="textarea" name="rejectionMessage" placeholder="Enter rejection reason" th:text="${app.rejectionReason}"></textarea>
                </div>

                <p class="muted" th:if="${selectedStatus == 'PENDING' or selectedStatus == 'APPLIED'}">
                    No extra input required for this status.
                </p>

                <div class="actions">
                    <button class="btn btn-primary" type="submit">Update Status</button>
                    <a th:if="${app.issuedDownloadAllowed}"
                       class="btn btn-success"
                       th:href="@{'/csc/application/' + ${app.id} + '/download-issued'}">Download Issued Document</a>
                </div>
            </form>
        </div>

        <div class="card">
            <h3>Customer Tracking / Status History</h3>
            <table>
                <thead>
                <tr>
                    <th>Stage</th>
                    <th>Status</th>
                    <th>Date / Time</th>
                    <th>Details</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Application Submitted</td>
                    <td>PENDING</td>
                    <td th:text="${app.submittedDate != null ? #temporals.format(app.submittedDate, 'dd-MM-yyyy HH:mm') : (app.createdAt != null ? #temporals.format(app.createdAt, 'dd-MM-yyyy HH:mm') : '-')}"></td>
                    <td>Customer submitted application and documents.</td>
                </tr>
                <tr th:if="${app.status == 'APPLIED' or app.successLikeStatus or app.status == 'REJECTED'}">
                    <td>Under Processing</td>
                    <td>APPLIED</td>
                    <td th:text="${app.updatedAt != null ? #temporals.format(app.updatedAt, 'dd-MM-yyyy HH:mm') : '-'}"></td>
                    <td>Application moved to processing by CSC.</td>
                </tr>
                <tr th:if="${app.successLikeStatus}">
                    <td>Completed</td>
                    <td th:text="${app.status}">SUCCESS</td>
                    <td th:text="${app.approvedDate != null ? #temporals.format(app.approvedDate, 'dd-MM-yyyy HH:mm') : (app.updatedAt != null ? #temporals.format(app.updatedAt, 'dd-MM-yyyy HH:mm') : '-')}"></td>
                    <td th:text="${app.issuedDocumentAvailable ? 'Issued document uploaded and available for customer download.' : 'Status marked as success.'}"></td>
                </tr>
                <tr th:if="${app.status == 'REJECTED'}">
                    <td>Closed</td>
                    <td>REJECTED</td>
                    <td th:text="${app.updatedAt != null ? #temporals.format(app.updatedAt, 'dd-MM-yyyy HH:mm') : '-'}"></td>
                    <td th:text="${app.rejectionReason != null ? app.rejectionReason : 'Application rejected.'}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div th:replace="~{fragments/layout :: footer}"></div>
</body>
</html>
